<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>合约补仓与双向持仓对冲计算器</title>
  <!-- Plotly 在线 CDN -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      max-width: 980px;
      margin: 18px auto;
      padding: 0 12px 60px;
      color: #222;
      background: #fafafa;
    }
    h1 { text-align: center; margin-bottom: 6px; }
    h2 { text-align: left; margin-top: 26px; color: #333; }
    .section {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      padding: 12px 14px;
      margin-bottom: 18px;
    }
    .form-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }
    label { min-width: 120px; font-weight: 600; }
    input[type="number"], select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ddd;
      min-width: 180px;
      font-size: 14px;
    }
    .small { min-width: 120px; }
    button {
      background: linear-gradient(180deg,#0b76ff,#0063d1);
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 6px 16px rgba(11,118,255,0.12);
    }
    button:active { transform: translateY(1px); }
    #result, #reverseResult {
      margin-top: 10px;
      padding: 8px;
      background: #f6f8fb;
      border-radius: 6px;
      font-family: monospace;
    }
    #chart {
      margin-top: 18px;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .input-group { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .center { text-align:center; margin-top:12px; }
    #balanceInfo {
      margin-top: 10px;
      font-weight: 600;
      text-align: center;
    }
    @media (max-width:640px){
      label { min-width: 100px; }
    }
  </style>
</head>
<body>
  <h1>合约补仓与双向持仓对冲计算器</h1>

  <!-- 一、正向补仓计算 -->
  <div class="section" id="forwardSection">
    <h2>补仓后均价</h2>
    <div class="form-row">
      <label>原始仓位方向：</label>
      <select id="direction" class="small">
        <option value="long">多单补仓</option>
        <option value="short">空单补仓</option>
      </select>
    </div>

    <div class="form-row">
      <label>开仓均价：</label>
      <input type="number" id="origPrice" placeholder="例如 4239.10" step="any" />
      <label>开仓数量：</label>
      <input type="number" id="origQty" placeholder="例如 1.3" step="any" />
    </div>

    <div class="form-row">
      <label>补仓价格：</label>
      <input type="number" id="addPrice" placeholder="例如 4100" step="any" />
      <label>补仓数量：</label>
      <input type="number" id="addQty" placeholder="例如 0.5" step="any" />
    </div>

    <div class="center">
      <button id="btnCalcForward">计算补仓后均价</button>
    </div>

    <div id="result" aria-live="polite"></div>
  </div>

  <!-- 插入图表的位置：放在正向补仓和反向计算之间 -->
  <div class="section">
    <h2>双向持仓对冲计算</h2>

    <div class="input-group">
      <label>多单均价:</label>
      <input type="number" id="longPrice" placeholder="例如 3500" step="0.01" />
      <label>多单数量:</label>
      <input type="number" id="longQty" placeholder="例如 2" step="0.01" />
    </div>

    <div class="input-group">
      <label>空单均价:</label>
      <input type="number" id="shortPrice" placeholder="例如 4000" step="0.01" />
      <label>空单数量:</label>
      <input type="number" id="shortQty" placeholder="例如 2" step="0.01" />
    </div>

    <div class="center">
      <button id="btnDraw">确定（绘制图表）</button>
    </div>

    <div id="chart">
      <div id="plotlyChart" style="width:100%;height:520px;"></div>
      <div id="balanceInfo">尚未绘图 —— 请填写多/空仓并点击 “确定（绘制图表）”</div>
    </div>
  </div>

  <!-- 二、反向计算目标补仓 -->
  <div class="section" id="reverseSection">
    <h2>反向计算目标补仓</h2>
    <div class="form-row">
      <label>当前开仓均价：</label>
      <input type="number" id="curPrice" placeholder="例如 4239.10" step="any" />
      <label>当前持仓数量：</label>
      <input type="number" id="curQty" placeholder="例如 1.3" step="any" />
    </div>

    <div class="form-row">
      <label>目标补仓后均价：</label>
      <input type="number" id="tgtAvg" placeholder="例如 4150" step="any" />
    </div>

    <div class="form-row" style="align-items:center;">
      <label style="min-width:0;">计算模式：</label>
      <label><input type="radio" name="mode" value="price" checked onclick="toggleReverseInputs()" /> 计算补仓价格 P₁</label>
      <label style="margin-left:10px;"><input type="radio" name="mode" value="qty" onclick="toggleReverseInputs()" /> 计算补仓数量 Q₁</label>
    </div>

    <div class="form-row">
      <label>补仓数量 Q₁：</label>
      <input type="number" id="revQty" placeholder="填写数量，自动算价格" step="any" />
      <label>补仓价格 P₁：</label>
      <input type="number" id="revPrice" placeholder="填写价格，自动算数量" step="any" />
    </div>

    <div class="center">
      <button id="btnCalcReverse">开始计算</button>
    </div>

    <div id="reverseResult"></div>
  </div>

  <script>
    // ---------- 辅助：安全型 isNumber 检查 ----------
    function isNumber(v) {
      return typeof v === 'number' && !isNaN(v) && isFinite(v);
    }

    // ---------- 正向补仓后均价计算 ----------
    function calcForward() {
      const dir = document.getElementById('direction').value;
      let p0 = parseFloat(document.getElementById('origPrice').value);
      let q0 = parseFloat(document.getElementById('origQty').value);
      let p1 = parseFloat(document.getElementById('addPrice').value);
      let q1 = parseFloat(document.getElementById('addQty').value);

      if (![p0,q0,p1,q1].every(isNumber)) {
        alert('请完整填写所有输入项（开仓均价/数量、补仓价格/数量）');
        return;
      }

      // 空单补仓：视作负数量统一计算
      if (dir === 'short') {
        q0 = -Math.abs(q0);
        q1 = -Math.abs(q1);
      }

      if ((q0 + q1) === 0) {
        alert('合并后持仓数量为 0，无法计算均价。请检查输入。');
        return;
      }

      const avg = (p0 * q0 + p1 * q1) / (q0 + q1);
      document.getElementById('result').innerText = '补仓后均价 = ' + avg.toFixed(8);
    }

    // ---------- 反向计算：给定目标均价计算 P1 或 Q1 ----------
    function toggleReverseInputs() {
      const mode = document.querySelector('input[name="mode"]:checked').value;
      if (mode === 'price') {
        document.getElementById('revQty').disabled = false;
        document.getElementById('revPrice').disabled = true;
        document.getElementById('revPrice').value = '';
      } else {
        document.getElementById('revQty').disabled = true;
        document.getElementById('revPrice').disabled = false;
        document.getElementById('revQty').value = '';
      }
      document.getElementById('reverseResult').innerText = '';
    }

    function calcReverse() {
      const p0 = parseFloat(document.getElementById('curPrice').value);
      const q0 = parseFloat(document.getElementById('curQty').value);
      const pt = parseFloat(document.getElementById('tgtAvg').value);
      const mode = document.querySelector('input[name="mode"]:checked').value;

      if (![p0,q0,pt].every(isNumber)) {
        alert('请先填写：当前均价、当前数量、目标均价');
        return;
      }

      let out = '';
      if (mode === 'price') {
        const q1 = parseFloat(document.getElementById('revQty').value);
        if (!isNumber(q1)) {
          alert('请填写补仓数量 Q₁');
          return;
        }
        // P1 = (Pt*(Q0+Q1) - P0*Q0) / Q1
        const p1 = (pt * (q0 + q1) - p0 * q0) / q1;
        out = '所需补仓价格 P₁ = ' + p1.toFixed(8);
      } else {
        const p1 = parseFloat(document.getElementById('revPrice').value);
        if (!isNumber(p1)) {
          alert('请填写补仓价格 P₁');
          return;
        }
        // Q1 = Q0*(Pt - P0)/(P1 - Pt)
        if ((p1 - pt) === 0) {
          alert('P₁ 与 目标均价相等，会导致除以 0，请修改输入。');
          return;
        }
        const q1 = q0 * (pt - p0) / (p1 - pt);
        out = '所需补仓数量 Q₁ = ' + q1.toFixed(8);
      }

      document.getElementById('reverseResult').innerText = out;
    }

    // ---------- 双向持仓对冲计算与绘图 ----------
    function drawHedgeChart() {
      const longPrice = parseFloat(document.getElementById('longPrice').value);
      const longQty = parseFloat(document.getElementById('longQty').value);
      const shortPrice = parseFloat(document.getElementById('shortPrice').value);
      const shortQty = parseFloat(document.getElementById('shortQty').value);

      if (![longPrice,longQty,shortPrice,shortQty].every(isNumber)) {
        alert('请填写所有数值（多单均价/数量，空单均价/数量）');
        return;
      }

      // 横轴区间： [空均价 * 0.8, 空均价 * 1.2]
      const start = shortPrice * 0.8;
      const end = shortPrice * 1.2;
      const steps = 300;
      const priceArr = new Array(steps + 1);
      const longProfit = new Array(steps + 1);
      const shortProfit = new Array(steps + 1);
      const totalProfit = new Array(steps + 1);

      for (let i = 0; i <= steps; i++) {
        const price = start + (end - start) * (i / steps);
        priceArr[i] = price;
        longProfit[i] = (price - longPrice) * longQty;
        shortProfit[i] = (shortPrice - price) * shortQty;
        totalProfit[i] = longProfit[i] + shortProfit[i];
      }

      // 找到最接近 0 的索引（稳妥的盈亏平衡点估计）
      let balanceIdx = 0;
      for (let i = 1; i < totalProfit.length; i++) {
        if (Math.abs(totalProfit[i]) < Math.abs(totalProfit[balanceIdx])) {
          balanceIdx = i;
        }
      }
      const balancePoint = priceArr[balanceIdx];
      const minY = Math.min(...totalProfit);
      const maxY = Math.max(...totalProfit);

      const traceLong = {
        x: priceArr,
        y: longProfit,
        mode: 'lines',
        name: '多单收益',
        line: { color: 'green', width: 2 }
      };
      const traceShort = {
        x: priceArr,
        y: shortProfit,
        mode: 'lines',
        name: '空单收益',
        line: { color: 'red', width: 2 }
      };
      const traceTotal = {
        x: priceArr,
        y: totalProfit,
        mode: 'lines',
        name: '总收益',
        line: { color: 'blue', width: 2, dash: 'dot' }
      };

      const layout = {
        title: { text: '双向持仓收益曲线（多=绿 / 空=红 / 总=蓝）', font: { size: 16 } },
        xaxis: { title: '币价', range: [start, end], zeroline: false },
        yaxis: { title: '收益', autorange: true },
        hovermode: 'x unified',
        margin: { t: 48, b: 60, l: 64, r: 24 },
        legend: { orientation: 'h', x: 0.02, y: 1.05 },
        shapes: [
          // 竖线贯穿收益区间（你选择的方案 1）
          {
            type: 'line',
            x0: balancePoint,
            x1: balancePoint,
            y0: minY,
            y1: maxY,
            line: { color: 'black', width: 2, dash: 'dash' },
            layer: 'above'
          }
        ],
        annotations: [
          // 图中注释文字（靠近顶部）
          {
            x: balancePoint,
            y: maxY,
            xref: 'x',
            yref: 'y',
            text: '盈亏平衡点',
            showarrow: true,
            arrowhead: 2,
            ax: 0,
            ay: -40,
            font: { color: '#000', size: 12 }
          },
          // 小标签显示具体价格值
          {
            x: balancePoint,
            y: maxY,
            xref: 'x',
            yref: 'y',
            text: (balancePoint !== undefined && !isNaN(balancePoint)) ? ('价: ' + balancePoint.toFixed(2)) : '',
            showarrow: false,
            yshift: -60,
            font: { color: '#000', size: 12, family: 'monospace' }
          }
        ]
      };

      Plotly.newPlot('plotlyChart', [traceLong, traceShort, traceTotal], layout, { responsive: true });

      // 在图下方显示可读的盈亏平衡价（方便复制/查看）
      if (balancePoint && !isNaN(balancePoint)) {
        document.getElementById('balanceInfo').innerText = '盈亏平衡价（估算）: ' + balancePoint.toFixed(6);
      } else {
        document.getElementById('balanceInfo').innerText = '未能计算盈亏平衡点（请检查输入）';
      }
    }

    // ---------- 事件监听绑定 ----------
    document.getElementById('btnCalcForward').addEventListener('click', calcForward);
    document.getElementById('btnCalcReverse').addEventListener('click', calcReverse);
    document.getElementById('btnDraw').addEventListener('click', drawHedgeChart);

    // 初始化反向计算输入控制
    toggleReverseInputs();
  </script>
</body>
</html>
